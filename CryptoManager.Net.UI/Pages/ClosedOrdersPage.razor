@page "/orders/closed"
@attribute [Authorize]

@inject IDialogService DialogService
@inject OrderService OrderService
@inject ExchangeService ExchangeService
@inject SymbolService SymbolService
@inject NavigationManager NavigationManager
@inject StreamService StreamService
@using CryptoExchange.Net.SharedApis
@using CryptoManager.Net.UI.Dialogs
@using CryptoManager.Net.UI.Models
@using CryptoManager.Net.UI.Services;
@using CryptoManager.Net.UI.Services.Rest
@using CryptoManager.Net.UI.Services.Stream
@implements IDisposable

<PageTitle>Orders | CryptoManager.Net</PageTitle>

<MudGrid Class="breadcrumbs" Spacing="0">
    <MudItem xs="12">
        <MudBreadcrumbs Items="breadcrumbs"></MudBreadcrumbs>
    </MudItem>
</MudGrid>

<MudGrid>
    <MudItem xl="12" lg="12" md="12" sm="12" xs="12">
        <MudPaper>
            <MudToolBar>
                <MudStack Row="true" Justify="Justify.FlexEnd" Style="width: 100%;">
                    <MudSelect OuterClass="no-flex" Style="width: 120px;" T="string" ValueChanged="@(s=>OnExchangeChange(s))" Placeholder="Exchange" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Web" IconSize="Size.Medium" Class="mt-0">
                        <MudSelectItem Value="@("All")" T="string"></MudSelectItem>
                        @foreach (var exchange in _exchanges)
                        {
                            <MudSelectItem Value="@exchange" T="string">@exchange</MudSelectItem>
                        }
                    </MudSelect>
                    <MudTextField @bind-Value="_baseAsset" Class="no-flex mt-0" Style="margin-left: 10px;" Placeholder="Base asset" @onkeyup="@(CheckEnter)" />
                    <MudTextField @bind-Value="_quoteAsset" Class="no-flex mt-0" Style="margin-left: 10px;" Placeholder="Quote asset" @onkeyup="@(CheckEnter)" />
                    <MudIconButton Icon="@Icons.Material.Filled.Search" OnClick="Refresh" />
                    <MudIconButton Size="Size.Medium" Icon="@Icons.Material.Filled.Refresh" OnClick="Refresh" />
                </MudStack>
            </MudToolBar>

            <OrdersTableComponent Open="false"
                                  @ref="_ordersTable"
                                  Authenticated="true"
                                  IncludeSymbolInfo="true"
                                  FailedToRetrieve="@_connectionIssues"
                                  OnTableReload="@LoadAsync"
                                  OnOrderClick="RowClickEvent"
                                  EmptyMessage="@(_symbolId == null ? "Select a symbol using the filters above": null)" />
        </MudPaper>
    </MudItem>
</MudGrid>


@code {
    private string? _exchange = null;
    private string? _baseAsset = null;
    private string? _quoteAsset = null;
    private string? _symbolId = null;
    private bool _connectionIssues = false;
    private OrdersTableComponent? _ordersTable;

    private List<ApiOrder>? _localOrders;
    private int _totalOrderCount;
    private string _sortDirection = "CreateTime";

    private List<BreadcrumbItem> breadcrumbs = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Closed Orders", href: "/orders/closed"),
    };

    private IEnumerable<string> _exchanges = Array.Empty<string>();

    protected override async Task OnInitializedAsync()
    {
        await ExchangeService.GetExchangeNamesAsync(
            data =>
            {
                _exchanges = data;
                return Task.CompletedTask;
            },
            error => Task.CompletedTask);

        StreamService.OnOrderChanged += HandleOrderUpdate;
    }

    private async Task Refresh()
    {
        if (_baseAsset == null || _quoteAsset == null)
            return;

        await OrderService.UpdateClosedOrdersAsync(() => Task.CompletedTask, null, _exchange, _baseAsset, _quoteAsset);
        _localOrders = null;
        _ordersTable?.Reload();
    }

    private Task HandleOrderUpdate(ApiOrder[] orders)
    {
        if (_localOrders == null) // No local list; nothing to do with update
            return Task.CompletedTask;

        foreach (var order in orders)
        {
            var symbolParts = order.SymbolId.Split("-");
            if (!string.IsNullOrEmpty(_exchange) && symbolParts[0] != _exchange)
                continue;

            if (!string.IsNullOrEmpty(_baseAsset) && symbolParts[1] != _baseAsset)
                continue;

            if (!string.IsNullOrEmpty(_quoteAsset) && symbolParts[2] != _quoteAsset)
                continue;

            var localOrder = _localOrders.SingleOrDefault(x => x.Id == order.Id);
            if (localOrder != null)
            {
                // We have this order in the current list; update it
                localOrder.AveragePrice = order.AveragePrice;
                localOrder.QuantityFilledBase = order.QuantityFilledBase;
                localOrder.QuantityFilledQuote = order.QuantityFilledQuote;
            }
            else
            {
                // We don't have this order in the current list

                if (order.Status == SharedOrderStatus.Open)
                    // The new order is not closed
                    continue;

                if (_sortDirection == "CreateTime" && order.CreateTime > _localOrders.Max(x => x.CreateTime))
                {
                    _localOrders.Insert(0, order);
                    _totalOrderCount += 1;
                }

            }
        }

        _ordersTable?.Reload();
        return Task.CompletedTask;
    }

    private void CheckEnter(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
            _ordersTable?.Reload();
    }

    private async Task<TableData<ApiOrder>> LoadAsync(TableState state)
    {
        if (_baseAsset == null || _quoteAsset == null)
            return new TableData<ApiOrder>();


        _sortDirection = state.SortLabel?.ToString() ?? "CreateTime";
        if (_localOrders != null)
            return new TableData<ApiOrder>() { Items = _localOrders, TotalItems = _totalOrderCount };


        _symbolId = $"{_exchange}-{_baseAsset}-{_quoteAsset}";
        await OrderService.GetClosedOrdersAsync(
            data =>
            {
                _localOrders = data.Items.ToList();
                _totalOrderCount = data.TotalResults;
                _connectionIssues = false;
                return Task.CompletedTask;
            },
            x => 
            {
                _localOrders = null;
                _totalOrderCount = 0;
                _connectionIssues = true;
                return Task.CompletedTask;
            },
            exchange: _exchange,
            baseAsset: _baseAsset,
            quoteAsset: _quoteAsset,
            sort: state.SortLabel,
            sortDirection: state.SortDirection.ToString(),
            page: state.Page + 1,
            pageSize: state.PageSize);

        return new TableData<ApiOrder>() { Items = _localOrders, TotalItems = _totalOrderCount };
    }

    private async Task RowClickEvent(ApiOrder order)
    {
        var orderDialog = await DialogService.ShowAsync<OrderDialog>(null, new DialogParameters<OrderDialog>
        {
            { x => x.Id, order.Id },
        }, new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            FullWidth = true,
            CloseButton = true 
        });
        await orderDialog.Result;
    }

    private void OnExchangeChange(string text)
    {
        _exchange = text == "All" ? null : text;
        _baseAsset = null;
        _quoteAsset = null;
        _ordersTable?.Reload();
        StateHasChanged();
    }

    public void Dispose()
    {
        StreamService.OnOrderChanged -= HandleOrderUpdate;
    }
}
